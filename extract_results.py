import json
import argparse
from tqdm import tqdm

def main():
    parser = argparse.ArgumentParser(description="Extract key evaluation fields to generate a concise report")
    parser.add_argument("--input_file", required=True, help="Input file path (Output from metrics.py)")
    parser.add_argument("--output_file", required=True, help="Output file path")
    args = parser.parse_args()

    print(f"Extracting data from {args.input_file}...")
    
    extracted_count = 0
    with open(args.input_file, 'r', encoding='utf-8') as f_in, \
         open(args.output_file, 'w', encoding='utf-8') as f_out:
        
        for line in tqdm(f_in, desc="Processing"):
            line = line.strip()
            if not line: continue
            
            try:
                data = json.loads(line)
            except json.JSONDecodeError:
                print(f"[Warning] Skipping corrupted line")
                continue
            
            # Get metrics dictionary (generated by metrics.py)
            metrics = data.get("metrics", {})
            
            # Construct target dictionary structure
            new_record = {
                "id": data.get("id", ""),
                "question_type": data.get("question_type", ""),  # Added question_type to report
                "model_prediction": data.get("model_prediction", ""),
                "evaluation_result": data.get("evaluation_result", {
                    "reasoning": "", 
                    "matched_ids": []
                }),
                # Map scores from the metrics object, None if missing
                "overall_score": metrics.get("score_overall", None),
                "answer_score": metrics.get("score_final", None)
            }
            
            f_out.write(json.dumps(new_record, ensure_ascii=False) + "\n")
            extracted_count += 1

    print(f"‚úÖ Extraction complete! Processed {extracted_count} records.")
    print(f"üìÅ Results saved to: {args.output_file}")

if __name__ == "__main__":
    main()